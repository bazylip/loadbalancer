name: Example usage of loadbalancer
on: push
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Prepare configs
        run: |
          sudo apt-get install gcc libpq-dev -y
          sudo apt-get install python-dev  python-pip -y
          sudo apt-get install python3-dev python3-pip python3-venv python3-wheel python3-setuptools -y
          pip3 install wheel
          pip3 install -r requirements.txt
          ./entrypoint.py 2
      - name: Build and run servers
        run: docker-compose up -d
      - name: Run load generator
        run: |
          python3 tools/load_generator/load_generator.py -a localhost -n 20
      - name: Print docker-compose logs
        run:
          docker-logs
      - name: Analyse docker-compose logs
        run: |
          echo "Requests sent: 20\n"
          echo "Requests served by server 1:" $(docker-compose logs | grep "server_1_1.*GET.*" | wc -l)
          echo "Requests served by server 2:" $(docker-compose logs | grep "server_2_1.*GET.*" | wc -l)
